<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>íì˜¤ì¼ ê¸°ë¡ ê´€ë¦¬</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">
<div class="container py-4">
  <h1 class="mb-4">íì˜¤ì¼ ê¸°ë¡ ê´€ë¦¬</h1>

  <div class="row g-3 align-items-end">
    <div class="col-md-3">
      <label class="form-label">ì¡°íšŒ ë‚ ì§œ</label>
      <input type="date" id="datePicker" class="form-control">
    </div>
    <div class="col-md-6">
      <button id="searchByDateBtn" class="btn btn-primary">ë‚ ì§œë³„ ì¡°íšŒ</button>
      <button id="searchAllBtn" class="btn btn-outline-primary ms-2">ì „ì²´ ì¡°íšŒ</button>
      <a href="/static/index.html" class="btn btn-secondary ms-2">ì…ë ¥ í˜ì´ì§€</a>
    </div>
  </div>

  <div id="results" class="mt-4"></div>
</div>

<style>
.edit-icon {
  cursor: pointer;
  font-size: 14px;
}
.editing input {
  width: 100%;
  font-size: 0.8rem;
}
</style>

<script>
/* ğŸ”§ í…Œì´ë¸” í–‰ ë Œë”ë§ */
function readingRow(r) {
  let btnHtml = "";

  if (r.has_analysis) {
    btnHtml = `
      <button class="btn btn-sm btn-primary me-1"
        onclick="location.href='/analysis/${r.id}'">
        ë¶„ì„ê²°ê³¼í™•ì¸
      </button>
      <button class="btn btn-sm btn-warning"
        id="analyze-btn-${r.id}"
        onclick='handleAnalyze("${r.id}")'>
        ì¬ë¶„ì„
      </button>
    `;
  } else {
    btnHtml = `
      <button class="btn btn-sm btn-success"
        id="analyze-btn-${r.id}"
        onclick='handleAnalyze("${r.id}", ${JSON.stringify(r)})'>
        ë¶„ì„í•˜ê¸°
      </button>
    `;
  }

  return `
    <tr data-id="${r.id}">
      <td>
        <span class="edit-icon" onclick="enableEdit(this)">âœï¸</span>
      </td>
      <td>${r.id}</td>
      <td>${r.oil_Model}</td>
      <td>${new Date(r.timestamp).toLocaleString()}</td>
      <td>${r.viscosity ?? ''}</td>
      <td>${r.tbn ?? ''}</td>
      <td>${r.acid_number ?? ''}</td>
      <td>${r.wear_fe ?? ''}</td>
      <td>${r.wear_cu ?? ''}</td>
      <td>${r.wear_al ?? ''}</td>
      <td>${r.fuel_dilution ?? ''}</td>
      <td>${r.soot ?? ''}</td>
      <td>${r.mileage ?? ''}</td>
      <td>${r.notes ?? ''}</td>
      <td>${btnHtml}</td>
    </tr>
  `;
}

function enableEdit(icon) {
  const tr = icon.closest("tr");
  if (tr.classList.contains("editing")) return;

  tr.classList.add("editing");

  [...tr.children].forEach((td, idx) => {
    if (idx < 2 || idx === tr.children.length - 1) return;

    const value = td.innerText;
    td.innerHTML = `<input value="${value}" />`;
  });

  tr.querySelectorAll("input").forEach(input => {
    input.addEventListener("keydown", e => {
      if (e.key === "Enter") {
        e.preventDefault();
        saveEdit(tr);
      }
    });
  });
}

async function saveEdit(tr) {
  const tds = tr.children;
  const readingId = tr.dataset.id;

    const payload = {
    oil_Model: tds[2].querySelector("input")?.value || null,
    viscosity: parseFloat(tds[4].querySelector("input")?.value) || null,
    tbn: parseFloat(tds[5].querySelector("input")?.value) || null,
    acid_number: parseFloat(tds[6].querySelector("input")?.value) || null,
    wear_fe: parseFloat(tds[7].querySelector("input")?.value) || null,
    wear_cu: parseFloat(tds[8].querySelector("input")?.value) || null,
    wear_al: parseFloat(tds[9].querySelector("input")?.value) || null,
    fuel_dilution: parseFloat(tds[10].querySelector("input")?.value) || null,
    soot: parseFloat(tds[11].querySelector("input")?.value) || null,
    mileage: parseInt(tds[12].querySelector("input")?.value) || null,
    notes: tds[13].querySelector("input")?.value || null
  };

  const res = await fetch(`/api/readings/${readingId}`, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  if (!res.ok) {
    alert("ìˆ˜ì • ì‹¤íŒ¨");
    return;
  }

  document.getElementById("searchAllBtn").click();
}

/* ğŸ”§ í…Œì´ë¸” ì¶œë ¥ */
function renderTable(items) {
  if (items.length === 0) {
    document.getElementById('results').innerHTML =
      '<div class="alert alert-info">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
    return;
  }

  const html = `
    <table class="table table-striped table-sm">
      <thead>
        <tr>
          <th></th><th>ID</th><th>oil Model</th><th>ì‹œê°„</th><th>ì ë„</th><th>TBN</th><th>AN</th>
          <th>Fe</th><th>Cu</th><th>Al</th><th>FuelDil</th>
          <th>Soot</th><th>Mileage</th><th>Notes</th><th>ë¶„ì„</th>
        </tr>
      </thead>
      <tbody>
        ${items.map(r => readingRow(r)).join('')}
      </tbody>
    </table>
  `;
  document.getElementById('results').innerHTML = html;
}

/* ğŸ”§ ë‚ ì§œë³„ ì¡°íšŒ */
document.getElementById('searchByDateBtn').addEventListener('click', async () => {
  const d = document.getElementById('datePicker').value;
  if (!d) {
    alert('ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”.');
    return;
  }

  try {
    const res = await fetch(`/api/readings/by-date?date=${d}`);
    if (!res.ok) throw new Error('ì„œë²„ ì˜¤ë¥˜');
    renderTable(await res.json());
  } catch (err) {
    alert(err.message);
  }
});

/* ğŸ”§ ì „ì²´ ì¡°íšŒ */
document.getElementById('searchAllBtn').addEventListener('click', async () => {
  try {
    const res = await fetch(`/api/readings/all`);
    if (!res.ok) throw new Error('ì„œë²„ ì˜¤ë¥˜');
    renderTable(await res.json());
  } catch (err) {
    alert(err.message);
  }
});

/* ğŸ”§ ë¶„ì„ ì„œë²„ ì „ì†¡ */
async function sendToAnalysisServer(r) {
  const payload = {
    id: r.id,
    oil_Model: r.oil_Model,
    time: r.timestamp,
    viscosity: r.viscosity,
    tbn: r.tbn,
    an: r.acid_number,
    fe: r.wear_fe,
    cu: r.wear_cu,
    al: r.wear_al,
    fuel_dilution: r.fuel_dilution,
    soot: r.soot,
    mileage: r.mileage,
    notes: r.notes
  };

  try {
    const res = await fetch(ANALYSIS_SERVER_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    if (!res.ok) throw new Error("ë¶„ì„ ì„œë²„ ì „ì†¡ ì‹¤íŒ¨");
    alert("ë¶„ì„ ìš”ì²­ ì„±ê³µ");
  } catch (err) {
    alert(err.message);
  }
}

/* ğŸ”§ ê¸°ë³¸ ë‚ ì§œ = ì˜¤ëŠ˜ */
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('datePicker').value =
    new Date().toISOString().slice(0,10);
});

async function handleAnalyze(readingId) {
  const btn = document.getElementById(`analyze-btn-${readingId}`);

  // âœ… ì´ë¯¸ ë¶„ì„ ì™„ë£Œ ìƒíƒœë©´ â†’ ê²°ê³¼ í˜ì´ì§€ë¡œ ì´ë™
  if (btn.dataset.state === "done") {
    window.location.href =
      `/analysis/${readingId}`;
    return;
  }

  btn.disabled = true;
  btn.innerText = "ë¶„ì„ ì¤‘...";

  try {
    // ğŸ”¥ ìµœì‹  reading ë‹¤ì‹œ ì¡°íšŒ
    const res = await fetch(`/api/readings/${readingId}`);
    if (!res.ok) throw new Error("ìµœì‹  ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨");

    const r = await res.json();

    const payload = {
      id: r.id,
      oil_Model:r.oil_Model,
      time: r.timestamp,
      viscosity: r.viscosity,
      tbn: r.tbn,
      an: r.acid_number,
      fe: r.wear_fe,
      cu: r.wear_cu,
      al: r.wear_al,
      fuel_dilution: r.fuel_dilution,
      soot: r.soot,
      mileage: r.mileage,
      notes: r.notes
    };

    const analyzeRes = await fetch(
      `/analyze/api/analyze?reading_id=${readingId}`,
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      }
    );

    if (!analyzeRes.ok) throw new Error("ë¶„ì„ ì‹¤íŒ¨");

    // âœ… ë¶„ì„ ì™„ë£Œ ìƒíƒœë¡œ ì „í™˜
    btn.innerText = "ë¶„ì„ê²°ê³¼í™•ì¸";
    btn.dataset.state = "done";

  } catch (err) {
    alert(err.message);
    btn.innerText = "ì¬ë¶„ì„";
    btn.dataset.state = "idle";
  } finally {
    btn.disabled = false;
  }
}

</script>
</body>
</html>