<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>폐오일 입력</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap CDN (개발용) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container py-4">
    <h1 class="mb-4">폐오일 측정값 입력</h1>

    <form id="readingForm" class="row g-3">

      <div class="col-md-3">
        <label class="form-label">ID</label>
        <input step="any" type="text" name="id" id="oilId" class="form-control">
      </div>

      <div class="col-md-3">
        <label class="form-label">Oil Model</label>
        <input step="any" type="text" name="oil_Model" class="form-control">
      </div>

      <div class="col-md-3">
        <label class="form-label">점도 (Viscosity)</label>
        <input step="any" type="number" name="viscosity" class="form-control">
      </div>

      <div class="col-md-3">
        <label class="form-label">TBN</label>
        <input step="any" type="number" name="tbn" class="form-control">
      </div>

      <div class="col-md-3">
        <label class="form-label">산가 (AN)</label>
        <input step="any" type="number" name="acid_number" class="form-control">
      </div>

      <div class="col-md-3">
        <label class="form-label">Fe (철)</label>
        <input step="any" type="number" name="wear_fe" class="form-control">
      </div>

      <div class="col-md-3">
        <label class="form-label">Cu (구리)</label>
        <input step="any" type="number" name="wear_cu" class="form-control">
      </div>

      <div class="col-md-3">
        <label class="form-label">Al (알루미늄)</label>
        <input step="any" type="number" name="wear_al" class="form-control">
      </div>

      <div class="col-md-3">
        <label class="form-label">연료 희석 (%)</label>
        <input step="any" type="number" name="fuel_dilution" class="form-control">
      </div>

      <div class="col-md-3">
        <label class="form-label">그을음 (Soot)</label>
        <input step="any" type="number" name="soot" class="form-control">
      </div>

      <div class="col-md-3">
        <label class="form-label">마일수 (주행거리)</label>
        <input step="1" type="number" name="mileage" class="form-control">
      </div>

      <div class="col-12">
        <label class="form-label">비고</label>
        <textarea class="form-control" name="notes" rows="2"></textarea>
      </div>

      <div class="col-12">
        <button id="submitBtn" type="submit" class="btn btn-primary">저장</button>
        <a href="/static/list.html" class="btn btn-secondary ms-2">목록</a>
      </div>
    </form>

    <div id="alert" class="mt-3"></div>
  </div>

<script>
document.getElementById("oilId").addEventListener("input", function (e) {
  let v = e.target.value.replace(/[^A-Za-z0-9]/g, "");  // 영숫자만 추출

  // 원하는 패턴: 4글자 - 4글자 - 1글자 - 3글자
  let p1 = v.slice(0, 4);
  let p2 = v.slice(4, 8);
  let p3 = v.slice(8, 9);
  let p4 = v.slice(9, 12);

  let formatted = p1;
  if (p2) formatted += "-" + p2;
  if (p3) formatted += "-" + p3;
  if (p4) formatted += "-" + p4;

  e.target.value = formatted;
});

document.getElementById('readingForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  const form = e.target;
  const data = {};
  
  new FormData(form).forEach((value, key) => {
    if (value === "") return;

    // 숫자 변환은 id 제외
    if (key !== "id" && !isNaN(value) && value !== null) {
      data[key] = value.includes('.') ? parseFloat(value) : parseInt(value);
    } else {
      data[key] = value;
    }
  });

  try {
    const res = await fetch('/api/readings', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(data)
    });
    if (!res.ok) {
      const txt = await res.text();
      throw new Error(`서버 오류: ${res.status} ${txt}`);
    }
    const json = await res.json();
    document.getElementById('alert').innerHTML =
      `<div class="alert alert-success">저장 완료 (ID: ${json.id})</div>`;
    form.reset();
  } catch (err) {
    document.getElementById('alert').innerHTML =
      `<div class="alert alert-danger">오류: ${err.message}</div>`;
    console.error(err);
  }
});

// ID 자동 하이폰 처리
document.getElementById("oilId").addEventListener("input", function(e) {
  let v = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, ""); // 영문+숫자만 유지
  let out = "";

  // P001-C001-A-001 패턴 적용
  if (v.length <= 4) {
    out = v;
  } else if (v.length <= 9) {
    out = v.slice(0, 4) + "-" + v.slice(4);
  } else if (v.length <= 11) {
    out = v.slice(0, 4) + "-" + v.slice(4, 8) + "-" + v.slice(8);
  } else {
    out = v.slice(0, 4) + "-" + v.slice(4, 8) + "-" + v.slice(8, 9) + "-" + v.slice(9, 12);
  }

  e.target.value = out;
});

document.getElementById("oilId").addEventListener("blur", async function () {
  const id = this.value;
  if (!id) return;

  const res = await fetch(`/api/readings/${id}`);
  if (!res.ok) return;

  const data = await res.json();
  Object.entries(data).forEach(([k, v]) => {
    const el = document.querySelector(`[name="${k}"]`);
    if (el && v !== null) el.value = v;
  });
});

</script>
</body>
</html>
